\section{Алгоритм вычисления свойств компонентов на тарелках}

На рисунке \ref{fig:algo1} представлен алгоритм работы программы. На данном рисунке не показан первый этап связанный с расчетом энергии молекул добавляемых в систему. Часть алгоритма, выполняемая на видеокарте выделена прямоугольником. Как показали исследования наилучшим оказался альтернативный вариант, в котором происходит варьирование температуры для достижения заданного значения энергии на тарелке.

\begin{figure}
	\begin{center}
		\includegraphics[width=0.5\textwidth]{algo1.pdf}
	\end{center}
	\caption{Алгоритм расчета свойств на тарелках} \label{fig:algo1}
\end{figure}

На первом этапе исходя из вычислений свойств входящих потоков определяется значение энергии, которое необходимо добавляется с входящим потоком:
\begin{equation} \label{eq:inen}
	E_{in} = E_K + E_P = \dfrac{3}{2} k_B T \sum_{i=1}^{I} N_i  + \sum_{i=1}^{I} E_i  N_i  
\end{equation}
где $E_{in}$ --- энергия молекулы с входящим потоком; $E_K$ --- кинетическая энергия; $E_P$ --- потенциальная энергия; $k_B$ --- константа Больцмана; $T$ --- температура; $N_i$ --- количество молекул типа $i$; $E_i$ --- энергия одной молекулы, вычисленная на предыдущем этапе, $I$ --- количество добавляемых в ячейку молекул.

Далее необходимо из энергетического баланса определить суммарную (референсную) энергию на тарелке:
\begin{equation}
	E_{ref} = E_{in} + E{l} + E{v} - E_{loss}
\end{equation}
определяемую как сумма входящих потоков ($E_{in}$) в случае тарелки питания, энергии жидкости ($E_l$) преступаемой с верхней тарелки,  и энергии паровой фазы ($E_v$) с нижней тарелки, ($E_{loss}$) --- потеря энергии за счет теплообмена с окружающей средой (на данный момент данный функционал не реализован). Энергия жидкости и пара может быть вычислена по выражению \eqref{eq:inen}. В случае, если в колонне нет молекул, то энергия складывается только из энергии поступающих на тарелку питания молекул.

Первичная конфигурация молекул реализована в исходном файле <<dbox\_init.cu>>. Заданное в файле конфигурации программы количество молекул расставляется случайным образом в узлах кубической кристаллической решетки. 

\subsection{Алгоритм вычисления на видеокартах}

При моделировании методами молекулярной динамки и Монте ~-- Карло, система ведет себя макроскопически если в ней содержатся несколько сотен молекул. Однако с увеличением количества молекул увеличивается точность расчета за счет двух факторов. Во-первых размер системы ограничивает радиус обрезания потенциала, а он с вою очередь влияет на рассчитанные термодинамические и кинетические свойства \cite{Moultos2016,Jamali2018}. Во-вторых при увеличении размера системы уменьшаются флуктуации свойств в рассматриваемой ячейке, что позволяет уменьшать статистическую ошибку определения.

В настоящее время для высокопроизводительных расчетов широко применяются видеокарты. Графические процессоры по сравнению с центральными процессорами имеют на 2 порядка большее количество ядер, так новое поколение видеокарт Nvidia имеют более 1000 CUDA ядер. Однако для эффективного использования ресурсов необходимо программировать на достаточно низком уровне: вручную выделять и освобождать память, хранить 2 экземпляра переменных на центральном и графическом процессоре отдельно. Также в отличии от центрального процессора, графические процессоры имеют несколько типов памяти регистровая, текстурная, общая.

В описанном выше алгоритме большую часть времени исполнения занимает вычисление свойств фаз на тарелках. Данные вычисления на каждой тарелке являются независимыми, поэтому могут быть проведены параллельно без потери производительности. Вычисление свойств входящих потоков проводилось на одной видеокарте (с индексом 0), в связи с тем, что обычно ходящий поток обычно один. Однако количество тарелок в реальных колоннах обычно больше 5, поэтому было принято решение использовать все доступные в системе видеокарты для увеличения производительности. В настоящее время использую дополнительно оборудование возможно одно временное использование вплоть до 16 видеокарт на одном компьютере.

\subsubsection{Представление данных в памяти видеокарты}

В памяти центрального процессора координаты молекул и атомов представлены в виде многомерных массивов. Размер массива определяется уровнем рассматриваемой абстракции. Свойства тарелок (например энергия, вириал, давление и т.д.) хранятся в одномерном массиве, индекс которого соответствует номеру тарелки. Свойства молекулы (координаты, текущая внутренняя и внешняя энергия и т.д.) представляют из себя двумерный массив, первый индекс которого соответствует номеру тарелки, второй --- номеру молекулы на тарелке. По аналогии с предыдущими примерами для свойств атома (координаты) массив трехмерный, последний индекс которого соответствует номеру атома в молекуле.

Однако указанную структуру данных нельзя использовать в видеокартах. Данные в памяти видеокарты могут быть представлены в виде одно или двумерного массива. Поэтому в данной работе описанная структура данных, преобразовывать которую удобно, преобразовывалась а одномерные массивы для расчета свойств фаз на тарелках. Структура данных представлена на рисунке \ref{fig:data_sheme}.

\begin{figure}
	\begin{center}
		\includegraphics[width=0.5\textwidth]{data.pdf}
	\end{center}
	\caption{Представление данных в памяти видеокарты} \label{fig:data_sheme}
\end{figure}

Расчеты каждой из тарелок осуществляются различными видеокартами (указаны на рисунке как <<device0>> и  <<device1>>). Количество молекул во все колонне может быть очень большое, поэтому для уменьшения времени копирования из памяти центрального процессора в память видеокарты каждая видеокарта получает лишь набор данных который будет обрабатывать. Все молекулы и атомы обрабатываемых тарелок на каждой из видеокарт хранятся в одном массиве. Поэтому для того, чтобы определять к какой тарелке относится та или иная молекула, был создан отдельный массив хранящий индекс первой молекулы на тарелке. Остальные молекулы на тарелке отсчитываются относительно данного индекса. Аналогичная ситуация с атомами, в памяти видеокарты хранится массив с индексом первого атома в каждой молекуле. Подготовка данных и копирование данных из памяти центрального процессора на видеокарту реализован в фале <<double\_devtohost.cu>>.

\subsubsection{Изменение конфигурации молекул}

Вычисление фазового равновесия системы предполагает как минимум у типа изменения конфигурации молекул: перемещение молекул, изменение объемов паровой и жидкой фаз и перенос молекул между фазами. В каждом из типов изменения системы необходимо рассчитать  энергию системы до и после изменения конфигурации. Принятие или не принятие данного перемещения рассчитывается по вероятности исходя из разницы энергии системы и температуры. Таким образом выстраивается марковская цепь, описывающая эволюцию рассматриваемой системы в фазовом пространстве. 

Вычисление энергии системы является одной из наиболее затратных операций, потому что необходимо вычислить потенциал взаимодействия одной молекулы со всеми соседями. В связи с тем, что координаты молекул не меняются во время расчета энергии системы, данная операция проводилась во множество потоков:
\begin{itemize}
	\item Каждый поток вычисляет энергию взаимодействия с $N_{mol}/N_{thread}$ молекул, где $N_{mol}$ ---количество молекул, $N_{thread}$ --- количество потоков. Таким образом каждый поток рассчитывает взаимодействие с определенной частью молекул и записывает энергию в отдельный элемент массива.
	\item Для того, чтобы убедиться, что все энергии были подсчитаны проводится барьерная синхронизация.
	\item Далее проводится суммирование элементов массива с использованием одного из алгоритмов адаптированных для видеокарт \cite{cudabook}.
\end{itemize}

При перемещении молекулы вероятность принятия перемещения определяется выражением \cite{Fernandes2015}:
\begin{equation}
	p_{move} = exp \left(\dfrac{-(U_{new} - U_{old})}{k_B T} \right)
\end{equation}
где индексы $new$ и $old$ показывают новое и старое состояние системы. Если энергия в новой конфигурации системы меньше чем в старой, то данное перемещение примется (вероятность равна 1).

Аналогичные выражения записываются для изменения объема газовой и жидкой фаз:
\begin{equation}
	p_{vol} =  exp \left(\dfrac{-(U_{new.vap} + U_{new.liq} - U_{old_vap} - U_{old.liq})}{k_B T} 
	- N_{vap} \ln \left( \dfrac{V_{vap} + \Delta V}{V_{vap}} \right) \\
	-  N_{liq} \ln \left( \dfrac{V_{liq} - \Delta V}{V_{liq}} \right) 
	\right) 
\end{equation}
где $vap$ и $liq$ --- индексы показывают энергию газовой и жидкой фазы, $\Delta V$ --- изменение объема системы, $N_{vap}$ и  $N_{liq}$ --- количество молекул в газовой и жидкой фазе.

Вероятность перемещения молекулы из одной фазы в другую:
\begin{equation}
p_{vol} =  exp \left(\dfrac{-(U_{new.vap} + U_{new.liq} - U_{old_vap} - U_{old.liq})}{k_B T} 
- \ln \left( \dfrac{V_{vap} (N_{liq})}{V_{vap}} \right) \right) 
\end{equation}

Указанные типы изменения конфигурации системы реализованы в разработанной программе. На каждом шагу Монте-Карло происходит случайное перемещение молекулы. Каждый 10 шаг в значения энергии, давления, количества молекул, объема, плотности записываются в переменную для усреднения. Каждый 100 шаг происходит попытка изменения объема газовой и жидкой фаз, а также перемещения случайной молекулы между фазами.

Изменения (расстояние перемещения молекулы, изменение объема) проводятся на случайную величину. Максимальное значение перемещения динамически изменяется каждые 10000 попыток перемещения таким образом, чтобы отношение приятных к непринятых  перемещений было примерно равно 0.5. Для этого при увеличении отношения более 0.6 шаг увеличивается на 20\%. Аналогично при снижении отношения менее 0.4, шаг уменьшается на 20 \%. Также шаг не может превышать половину длины ячейки и быть меньше 0.01 нм. Максимальное изменение объема жидкой фазы фиксировано и составляет 1\%.

\subsubsection{Определение температуры на тарелках}

Для вычисления температуры на тарелке, необходимо, чтобы рассматриваемая система находилась в равновесии. Для определения достижения равновесия, вычисления разбиваются на блоки (на момент отладки программы размер блока составлял 100000 шагов Монте~-Карло). В каждом из блоков определяются средние значения свойств (энергии, давления, плотности, концентрации и т.д.). 

Для того, чтобы определить, установилось ли равновесие в системе, определяется среднее значение по 5 последним блокам. Равновесие считается достигнутым, в том случае, если отклонения от среднего значения составляют более 5\% (проценты отличаются для каждого из свойств).
Проверка установления осуществляется по следующим свойствам: по энергии паровой и жидкой фаз, плотности жидкой фазы, давлению паровой фазы.
Давление жидкой фазы и плотность газовой испытывают большие флуктуации, поэтому по этим величинам сложно оценивать достижение равновесия системы.

После установления равновесия определяется энергия молекул на тарелке как сумма энергий газовой и жидкой фазы, а также кинетической энергией:
\begin{equation} \label{eq:curen}
E_{cur} = \dfrac{3}{2} k_B T (\sum_{i=1}^{N_{vap}} + \sum_{i=1}^{N_{liq}}) + E_{vap} + E_{liq}
\end{equation}

Далее осуществляется сравнение энергии $E_{cur}$  с рефересной энергией $E_{ref}$. К случае, если текущая энергия системы больше, то температура системы снижается (и наоборот в случае если энергия меньше) и цикл повторяется. В случае если разница энергий не превышает 2\%, то далее проводится дополнительный расчет, с большим количеством перемещений большей статистики в усреднении свойств системы.

\subsection{Перенос молекул между тарелками}

После установления равновесия происходит перенос молекул газовой фазы на одну тарелку вверх, молекулы жидкости на одну тарелку вверх, а также добавление или удаление молекул. Для экономии занимаемой оперативной памяти на видеокарте память на каждую тарелку выделяется согласно количеству молекул. Поэтому для изменения количества молекул на тарелке необходимо пересоздать массивы с новым количеством молекул и данная процедура должна проводиться на центральном процессоре.


\subsection{Влияние гидродинамической обстановки на процесс переноса}

Предложенный алгоритм не учитывает гидродинамическую обстановку на тарелке. Количество молекул в рассматриваемых системах не позволяет каким либо образом учитывать конструкцию тарелок. Разработанный метод также ка и метод теоретических тарелок основан на том, что на тарелке происходит установление термодинамического равновесия. Несмотря на это можно предложить два варианта которые в дальнейшем можно реализовать для решения данной проблемы.

Первый вариант основан использовании полуэмпирических выражений для определения к.п.д. по Мерфи. Для расчета данных коэффициентов необходимы коэффициенты переноса (диффузии, вязкости). Поэтому конфигурацию молекул, вычисленную в а разработанной программе можно использовать для расчета коэффициентов переноса с использованием пакета gromacs. При этому вычисления условий равновесия и коэффициентов переноса можно проводить параллельно.

Второй вариант основан на том чтобы не дожидаться установления условий равновесия на тарелке. Тогда состав, плотности и другие свойства на тарелке будут зависеть от количества сделанных шагов Монте~-Карло. Количество шагов Монте-Карло изоморфно времени в методе молекулярной динамики. Таким образом регулируя количество шагов изменяется время взаимодействия пара и жидкости. 


\subsection{Окружение и установка}

Сборка приложения осуществляется с использованием пакета Cmake, набора компиляторов gcc и библиотек cuda toolkit установить которые можно командой:
\begin{lstlisting}
sudo apt install cmake
sudo apt install gcc g++
sudo apt install nvidia-cuda-toolkit 
\end{lstlisting}

Для выявления зависимостей и создания файлов сборки необходимо запустить команду:
\begin{lstlisting}
cmake
\end{lstlisting}
Различные версии cuda toolkit обычно совместимы не с последней версией gcc, поэтому при компиляции можно указать какую именно версию компилятора использовать:
\begin{lstlisting}
cmake -DCMAKE_C_COMPILER=/usr/bin/gcc-6 -DCMAKE_CXX_COMPILER=/usr/bin/g++-6
\end{lstlisting}
Далее необходимо скомпилировать программу с помощью команды:
\begin{lstlisting}
make
\end{lstlisting}
В папке появится исполняемый файл.

\section{Визуализация расчетов программы}

Молекулярно-статистические методы требуют существенных вычислительных затрат. В связи с этим даже на высокопроизводительном оборудовании время, затраченное на вычисления, может составлять десятки часов. При моделировании неравновесных или неустановившихся процессов необходимо контролировать текущее состояние системы. В большинстве случаев программы сохраняют текущие свойства в виде текстовых файлов, например такие программы как gromacs \cite{Pronk2013} и towhee \cite{Martin2013}. Для визуализации данных можно воспользоваться графическими редакторами. Однако данный способ требует затрат времени. 

Программа осуществляет запись физико-химических свойств паровой и жидкой фаз на каждой тарелке ректификационной колонны в файл. Для каждой тарелки создается папка с названием <<plate-№тарелки>>, в котором хранятся результаты расчетов. Энергия, давление и другие 
Первая строка файла содержит описание характеристики, вторая строка содержит размерность величин. Последующие строки содержат значения физико-химических величин. 
Пример файла с данными:
\lstset{language=Pascal}
\begin{lstlisting}
cycle number	energy	vapor composition	pressure	temperature
no	J/mol	mol frac	bar	K
1	120	0.2	1	260
2	135	0.3	1.32	270
3	136	0.4	1.5	300
4	144.78803861562	0.556133765765478	2.3	310.10013627195
5	144.169386641327	0.5985991615124	3.16980857747587	310.555670976329
6	149.548525999929	0.501446874120906	3.16782959526555	310.003258276753
7	143.827119599023	0.585662135528444	3.16576977542854	310.944407476643
8	144.044716862953	0.599590463074216	3.08448201449308	310.329150103861
9	140.981959721285	0.527323214848039	3.02232150777213	310.080746716385
10	142.261477555272	0.548889975154957	3.11709420795045	310.003285864423
11	142.70898377206	0.564050477341758	3.01853174591303	310.968434813629
12	148.736902128591	0.575276156796512	3.18153658794448	310.839816872137
13	142.534306535427	0.548514678067799	3.19647971887008	310.119976620409
14	146.832988894578	0.537850383551013	3.15039582146607	310.32992897198
15	147.334992635238	0.54314051251355	3.05684519392893	310.266979312755
16	148.508113161646	0.563352449814567	3.12608646490167	310.692168231217
17	140.378344446634	0.521147735449389	3.16522065313047	310.773110326238
18	143.936391754645	0.502328285553782	3.13219699869719	310.167883000741
19	145.145474369276	0.564324288088821	3.18101680540676	310.174601223762
20	143.089074971632	0.572295830897665	3.06052441556237	310.761356159448
\end{lstlisting}

Визуализация расчетов реализована в виде интерактивной веб-страницы с возможностью выбора нужных параметров для отрисовки графиков. Обработка пользовательских запросов, парсинг данных и подготовка их для визуализации реализована на бэкенде веб-приложения, написанного на языке Python с фреймворком Flask \cite{flask}, непосредственно отрисовка графиков выполняется в браузере пользователя посредством фреймворка highcharts.js \cite{highcharts} языка программирования javascript.
Веб-приложение можно запускать как из непосредственно рабочей папки с расчетами, так и просто имея сохраненные выходные данные программы, в таком формате можно стартовать его как из-под Linux, так и из-под Windows или MacOS. Также можно настроить доступ к визуализации расчетов не только с локальной машины, на которой запущен веб-сервер, но и из внешнего интернета, настроив проксирующий веб-сервер, например, nginx.
На графики независимо друг от друга может выводиться статистика в двух срезах (рисунок \ref{fig:site}): термодинамический параметр на определенной тарелке в динамике всех циклов или термодинамический параметр в определенном цикле по каждой тарелке.

\begin{figure}
	\begin{center}
		\includegraphics[width=0.8\textwidth]{site.png}
	\end{center}
	\caption{Интерфейс веб-страницы с выводом данных в виде графика зависимости состава пара от цикла моделирования и зависимость состава пара на тарелках для заданного цикла моделирования} \label{fig:site}
\end{figure}

Количество тарелок / циклов / термодинамических параметров для визуализации высчитывается независимо от пользователя на основе парсинга визуализируемых данных. Таким образом, можно применять веб-интерфейс для контроля промежуточных результатов эксперимента без дополнительных настроек. Это позволяет осуществлять оперативный контроль результата моделирования, отслеживать момент установления термодинамического равновесия и проводить анализ результатов.

\subsection{Установка программы визуализации}

Установка и настройка программы визуализации проходит следующим образом:
\begin{itemize}
	\item Необходимо установить python и venv с подошью команд
	\begin{lstlisting}
	sudo apt install python3
	sudo apt install python3-venv
	\end{lstlisting}
	\item Программу можно склонировать из github репозитория:
	\begin{lstlisting}
	git clone https://github.com/kzncvs/mc_visualisation.git
	\end{lstlisting}
	\item Переходим в папку с программой:
	\begin{lstlisting}
	cd mc\_visualisation
	\end{lstlisting}
	\item Создаём виртуальное окружение
	\begin{lstlisting}
	python3 -m venv venv
	\end{lstlisting}
	\item Применяем виртуальное окружение
	\begin{lstlisting}
	source venv/bin/activate
	\end{lstlisting}
	\item Устанавливаем зависимости
	\begin{lstlisting}
	pip install -r requirements.txt
	\end{lstlisting}
	\item  Запускаем веб-сервер
	\begin{lstlisting}
	python3 app.py --host=127.0.0.1 --port 5000
	\end{lstlisting}
	\item Папка с исходными данными задается в фале  DATASET\_FOLDER/app.py
	
	
	Сайт с графиками доступен по адресу 127.0.0.1:5000.
	
\end{itemize}


